From ec762c9a3af6f4794750858aa80386a92a28f850 Mon Sep 17 00:00:00 2001
From: Deepali Chourasia <deepch23@in.ibm.com>
Date: Mon, 27 May 2024 09:20:39 +0000
Subject: [PATCH] update to build with GCC12

---
 recipe/conda_build_config.yaml |  2 ++
 recipe/install_base.sh         | 19 ++++++++++++++++++-
 recipe/meta.yaml               | 21 +++++++++++++--------
 3 files changed, 33 insertions(+), 9 deletions(-)

diff --git a/recipe/conda_build_config.yaml b/recipe/conda_build_config.yaml
index d53d8ac..4426880 100644
--- a/recipe/conda_build_config.yaml
+++ b/recipe/conda_build_config.yaml
@@ -8,3 +8,5 @@ c_compiler:    # [win]
   - vs2019     # [win]
 cxx_compiler:  # [win]
   - vs2019     # [win]
+blas_impl:
+  - openblas
diff --git a/recipe/install_base.sh b/recipe/install_base.sh
index 6661929..2c4320b 100644
--- a/recipe/install_base.sh
+++ b/recipe/install_base.sh
@@ -4,10 +4,27 @@ set -e
 
 UNAME_M=$(uname -m)
 
+EXTRA_OPTS=""
+echo $GCC_HOME
+
+if [[ $ppc_arch == "p10" ]]
+then
+    if [[ -z "${GCC_HOME}" ]];
+    then
+        echo "Please set GCC_HOME to the install path of gcc-toolset-12"
+        exit 1
+    else
+        export PATH=$GCC_HOME/bin:$PATH
+        export CC=$GCC_HOME/bin/gcc
+        export CXX=$GCC_HOME/bin/g++
+    fi
+fi
+
 case "$UNAME_M" in
     ppc64*)
         # Optimizations trigger compiler bug.
-        EXTRA_OPTS="--no-use-pep517 --global-option=build --global-option=--cpu-dispatch=min"
+         export CXXFLAGS="$(echo ${CXXFLAGS} | sed -e 's/ -fno-plt//')"
+         export CFLAGS="$(echo ${CFLAGS} | sed -e 's/ -fno-plt//')"
         ;;
     *)
         EXTRA_OPTS=""
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 82345d0..1130963 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -13,6 +13,8 @@ source:
 
 build:
   number: 0
+  script_env:      #[ppc_arch == 'p10']
+    - GCC_HOME     #[ppc_arch == 'p10']
   # numpy 1.26 no longer supports Python 3.8: https://numpy.org/devdocs/release/1.26.0-notes.html
   # "This release supports Python versions 3.9-3.12"
   skip: True  # [(blas_impl == 'openblas' and win)]
@@ -35,10 +37,13 @@ outputs:
         - f2py = numpy.f2py.f2py2e:main
       missing_dso_whitelist:  # [s390x]
         - $RPATH/ld64.so.1    # [s390x]
+      script_env:      #[ppc_arch == 'p10']
+        - GCC_HOME     #[ppc_arch == 'p10']
+
     requirements:
       build:
-        - {{ compiler('c') }}
-        - {{ compiler('cxx') }}
+        - {{ compiler('c') }}      #[ppc_arch != "p10"]
+        - {{ compiler('cxx') }}    #[ppc_arch != "p10"]
         - armpl  # [aarch64]        
         - ninja-base
         - pkg-config
@@ -71,8 +76,8 @@ outputs:
     requirements:
       build:
         # for runtime alignment
-        - {{ compiler('c') }}
-        - {{ compiler('cxx') }}
+        - {{ compiler('c') }}     #[ppc_arch != "p10"]
+        - {{ compiler('cxx') }}   #[ppc_arch != "p10"]
         - armpl  # [aarch64]
       host:
         - python
@@ -115,11 +120,11 @@ outputs:
         - pytest-xdist
         - hypothesis >=6.81.1
         - pytz >=2023.3
-        - {{ compiler('c') }}  # [not osx]
-        - {{ compiler('cxx') }}  # [not osx]
-        - {{ compiler('fortran') }}  # [not osx]
+        - {{ compiler('c') }}       #[ppc_arch != "p10"]
+        - {{ compiler('cxx') }}     #[ppc_arch != "p10"]
+        - {{ compiler('fortran') }} #[ppc_arch != "p10"]
         - nomkl  # [x86 and blas_impl != 'mkl']
-        - typing-extensions >=4.2.0
+        - typing-extensions {{ typing_extensions }}       
         - mypy >=1.5.1
         - cffi  # [py<310]
         - charset-normalizer
-- 
2.40.1

